name: AssetStudio 自动化构建与打包

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 .NET 运行时
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x  # 匹配构建日志中的 net8.0 版本

      - name: 还原项目依赖
        run: dotnet restore AssetStudio.sln  # 确认解决方案文件名正确

      - name: 构建项目（Release 模式）
        run: dotnet build AssetStudio.sln --configuration Release --no-restore

      - name: 查看构建输出目录（调试用）
        run: |
          # 查看 GUI 输出目录下的文件，确认 CLI 产物是否存在
          dir "AssetStudio.GUI/bin/Release/net8.0-windows"
        shell: pwsh

      - name: 压缩构建产物
        run: |
          # 修正构建产物目录（根据日志实际输出路径调整）
          $buildOutputPath = "AssetStudio.GUI/bin/Release/net8.0-windows"
          # 定义压缩包名称（包含时间戳）
          $zipName = "AssetStudio-Build-$(Get-Date -Format 'yyyyMMdd-HHmmss').zip"
          # 压缩目录下所有文件
          Compress-Archive -Path "$buildOutputPath/*" -DestinationPath "$zipName" -Force
        shell: pwsh

      - name: 上传压缩包作为 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: assetstudio-build
          path: "*.zip"
          retention-days: 7
